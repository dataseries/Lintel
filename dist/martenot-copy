#!/bin/sh
MARTENOT_REPO_DIR=/var/www/external/tesla.hpl.hp.com/opensource/repositories
if [ "$1" = "--diff" ]; then
    shift
    IN=$2
    OUT=$3
    BASE=`basename $IN`
    REF=$1/`echo $BASE | sed 's/i386/amd64/'`
    if [ ! -f $IN ]; then
        exit 1
    fi
    case $REF in
        *debian-lenny*.tar.gz) REF=`dirname $OUT`/../`basename $REF`-norsyncable ;;
    esac
    if [ ! -f $REF ]; then
        exit 1
    fi

    case $BASE in
        *.deb) debdelta $REF $IN $OUT ;;
        *) bsdiff $REF $IN $OUT ;;
    esac
    exit 0
elif [ "$1" = "--to-martenot" ]; then
    [ `id -u` != 0 ]
    set -e
    set -x
    [ $# = 3 ]
    REMOTE_TMP=$2
    DATE=$3
    MARTENOT_REPOS=martenot:$MARTENOT_REPO_DIR
    LOCALPKGS=/var/www/localpkgs
    for i in $LOCALPKGS/*-*-*; do
        DIR=/unknown
        [ -d $i/rpms ] && DIR=$i/rpms
        [ -d $i/incoming ] && DIR=$i/incoming
        [ -d $DIR ]
        rsync -av --exclude=\*.log $DIR $MARTENOT_REPOS/`basename $i`
    done
    rsync -av $0 martenot:$REMOTE_TMP/martenot-copy
    ssh martenot $REMOTE_TMP/martenot-copy --on-martenot-source $REMOTE_TMP $DATE
    ssh martenot $REMOTE_TMP/martenot-copy --on-martenot-binaries
elif [ "$1" = "--on-martenot-source" ]; then
    set -e
    set -x
    shift
    [ $# = 2 ]
    REMOTE_TMP=$1
    DATE=$2
    PROJ=$REMOTE_TMP/test-remote/projects
    WWW=/var/www/external/tesla.hpl.hp.com/opensource
    [ "`hostname`" = martenot ]

    cp $REMOTE_TMP/test-remote/deptool-bootstrap $WWW/deptool-bootstrap
    cp $PROJ/Lintel/NEWS $WWW/Lintel-NEWS.txt
    cp $PROJ/DataSeries/NEWS $WWW/DataSeries-NEWS.txt
    cp $PROJ/Lintel-$DATE.tar.bz2 $WWW/Lintel-$DATE.tar.bz2
    cp $PROJ/DataSeries-$DATE.tar.bz2 $WWW/DataSeries-$DATE.tar.bz2
elif [ "$1" = "--on-martenot-binaries" ]; then
    while killall -u `whoami` -TERM gpg-agent; do 
        echo killing gpg-agent...
        sleep 1
    done
    trap 'killall -TERM gpg-agent' 0
    eval `gpg-agent --daemon --no-grab`
    set -e
    for i in $MARTENOT_REPO_DIR/*-*-*; do
        echo "Processing $i..."
        (
            cd $i;
            if [ -d incoming ]; then
                [ -d conf ] || mkdir conf
                cat >conf/distributions <<EOF
Origin: Eric Anderson
Label: localpkgs
Suite: unstable
Codename: sid
Architectures: i386 amd64 all source
Components: main
Description: Local Packages
SignWith: Tesla_Software_Signing_Key
EOF
                # Simpler to just regenerate from scratch.
                rm -rf dists lists pool db
                for i in incoming/*changes; do
                    reprepro include sid $i
                done
            elif [ -d rpms ]; then
                rm -rf repodata
                createrepo .
                gpg --use-agent --batch --no-tty --display $DISPLAY -a --detach-sign --default-key Tesla_Software_Signing_Key repodata/repomd.xml
            else
                echo "Do not know how to handle $i"
                exit 1
            fi
        )
    done
elif [ "$1" = "--diff-localhost" ]; then
    # TODO: decide if we care about fixing the below; it's mainly useful for doing a release when
    # on a poorly connected network.  The idea is to compute a local diff, move the diff, 
    # recompute on the far side and rsync to fix any glitches.
    exit 1
    shift
    set -e
    set -x
    [ `id -u` != 0 ]
    [ -d "$1" ]
    WORKDIR=$1/tesla
    MARTENOT_REPOS=martenot:/var/www/external/tesla.hpl.hp.com/opensource/repositories
    DEB_REFERENCE=debian-wheezy-amd64
    RPM_REFERENCE=centos-5-x86_64
    LOCALPKGS=/var/www/localpkgs
    sudo mkdir -p $WORKDIR
    sudo chown `whoami` $WORKDIR
#    (rsync -av --progress --partial $DEB_REFERENCE/incoming $MARTENOT_REPOS/$DEB_REFERENCE;
#     rsync -av --progress --partial $RPM_REFERENCE/rpms $MARTENOT_REPOS/$RPM_REFERENCE) \
#         >$WORKDIR/rsync.initial 2>&1 &
    
#    [ ! -d $WORKDIR/transfer ] || rm -rf $WORKDIR/transfer
    mkdir -p $WORKDIR/transfer
    for i in /var/www/localpkgs/$DEB_REFERENCE/incoming/*.tar.gz; do
        echo "rezip $i"
        gunzip -c <$i | gzip -9v >$WORKDIR/transfer/`basename $i`-norsyncable
    done
    REFDIR=$LOCALPKGS/$DEB_REFERENCE/incoming
    for i in $LOCALPKGS/{debian,ubuntu}*; do
        OSVERARCH=`basename $i`
        mkdir -p $WORKDIR/transfer/$OSVERARCH
        sudo rm $i/incoming/*$OSVERARCH.dsc || true
    done
    batch-parallel make transform="s!^.*/([^/]+)/incoming/(.+)!$WORKDIR/transfer/\$1/\$2!" \
        command="$0 --diff $LOCALPKGS/$DEB_REFERENCE/incoming \$< \$@" \
        -- $LOCALPKGS/{debian,ubuntu}*/incoming
#
#        for j in $i/incoming/*; do
#            FILE=`basename $j`
#            REFFILE=`echo $FILE | sed 's/amd64/i386/'`
#            [ -f $REFDIR/$REFFILE ]
#            echo "$OSVERARCH/$FILE"
#        done
#    done
    wait
else
    echo "? $1"
    exit 1
fi
