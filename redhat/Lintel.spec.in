#
# SPEC file for Lintel
#
Name:           Lintel
Version:        __VERSION__
URL:            http://tesla.hpl.hp.com/opensource.html
Source:         %{name}-%{version}.tar.gz
# TODO-package-reviewer: can we have a no-release package?  We'll do a Lintel re-release on packaging glitches
Release:        __RELEASE__
Summary:        Support tools and library 
Group:          Development/Libraries
License:        BSD
Packager:	HPL SSD Software <software@cello.hpl.hp.com>
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
# special extra packages on CentOS5, from EPEL or elsewhere
BuildRequires: cmake, chrpath
# Standard packages
BuildRequires: boost-devel, chrpath, doxygen, sg3_utils, gnuplot, netpbm-progs, openssh-clients
BuildRequires: perl-DBI, perl-DBD-MySQL, libxml2-devel, tetex-latex, tetex-dvips, ghostscript

# TODO-package-reviewer: do we split shared libraries as in debian?
%package	libs
Summary:        Lintel library files
Group:          Development/Libraries
License:        BSD

%package	devel
Summary:        Lintel devel files
Group:          Development/Libraries
Requires:       %{name}-libs = %{version}-%{release}
Requires:       boost-devel, libxml2-devel
License:        BSD

%package	utils
Summary:        Lintel utilities
Group:          Development/Libraries
Requires:       %{name}-libs = %{version}-%{release}, perl-Lintel, tetex-latex, tetex-dvips
Requires:       ghostscript
License:        BSD

# TODO-package-reviewer: how do we make this package architecture independent?
%package	docs
Summary:        Lintel development files documentation
Group:          Development/Libraries
Requires:       %{name}-libs = %{version}-%{release}
License:        BSD

%package        -n perl-Lintel
Summary:        Lintel perl files
Group:          Development/Libraries
Requires:       %{name}-libs = %{version}-%{release}
License:        BSD

%description
This is the meta-package for Lintel, the -{libs,devel,utils,docs,perl} sub-packages contain
the actual contents.

__DESCRIPTION_liblintel-dev__

%description	libs
The redhat packaging combinds the two Lintel C++ libraries into a single
package.

__DESCRIPTION_liblintel0__

__DESCRIPTION_liblintelpthread0__

%description	devel
__DESCRIPTION_liblintel-dev__

%description    utils
__DESCRIPTION_lintel-utils__

%description    docs
__DESCRIPTION_liblintel-dev-doc__

%description    -n perl-Lintel
__DESCRIPTION_liblintel-perl__

%prep
%setup -q

%build
mkdir rpm-build
cd rpm-build
cmake -D CMAKE_INSTALL_PREFIX=/usr ..
make -j 6
ctest

%install
cd rpm-build
rm -rf $RPM_BUILD_ROOT
make install DESTDIR=$RPM_BUILD_ROOT
pwd
ls ..
../debian/fix-install.sh $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT%{_docdir}/Lintel-%{version}
cp ../Release.info ../Changelog.mtn ../COPYING $RPM_BUILD_ROOT%{_docdir}/Lintel-%{version}
# TODO: can we make cmake automatically figure out that centos wants libs in /usr/lib64
if [ %{_libdir} != /usr/lib ]; then
        mkdir -p $RPM_BUILD_ROOT%{_libdir}
        mv $RPM_BUILD_ROOT/usr/lib/libLintel*so* $RPM_BUILD_ROOT%{_libdir}
fi
mkdir -p $RPM_BUILD_ROOT/usr/share/doc/Lintel-devel
cat >$RPM_BUILD_ROOT/usr/share/doc/Lintel-devel/README <<EOF 
__DESCRIPTION_liblintel-dev__
EOF

strip $RPM_BUILD_ROOT/usr/lib/perl5/libLintelPerl.so
mkdir -p $RPM_BUILD_ROOT/usr/share/doc/perl-Lintel
cat >$RPM_BUILD_ROOT/usr/share/doc/perl-Lintel/README <<EOF 
__DESCRIPTION_liblintel-perl__
EOF

strip $RPM_BUILD_ROOT/usr/bin/drawRandomLogNormal
mkdir -p $RPM_BUILD_ROOT/usr/share/doc/Lintel-utils
cat >$RPM_BUILD_ROOT/usr/share/doc/Lintel-utils/README <<EOF 
__DESCRIPTION_lintel-utils__
EOF

strip $RPM_BUILD_ROOT/usr/lib64/libLintel*.so.*.*

%post libs -p /sbin/ldconfig

%postun libs -p /sbin/ldconfig

%clean
rm -rf $RPM_BUILD_ROOT rpm-build
./redhat/rules clean

# rpmlint complains about libLintel calling exit(), but that's intentional; 
# libLintel includes the equivalent of assert().
%files libs
%{_libdir}/libLintel.so.*
%{_libdir}/libLintelPThread.so.*
%{_docdir}/Lintel-%{version}/COPYING
%{_docdir}/Lintel-%{version}/Release.info

%files devel
%{_includedir}/Lintel/*
%{_bindir}/lintel-config
%{_libdir}/libLintel*.so
/usr/share/cmake-modules
/usr/share/packaging/redhat-rules
/usr/share/lintel-latex-rebuild
/usr/share/Lintel/doxygen.config.in
/usr/share/doc/Lintel-devel

%files utils
%{_bindir}/batch-parallel
%{_bindir}/deptool
%{_bindir}/drawRandomLogNormal
%{_bindir}/lintel-disktool
%{_bindir}/lintel-flock
%{_bindir}/lintel-latex-rebuild
%{_bindir}/mercury-plot
/usr/share/bp_modules/BatchParallel
/usr/share/doc/Lintel-utils
/usr/share/man/man1/*

# rpmlint complains about the manpages being compressed with gz instead of bz2,
# but all of the centos5 manpages are compressed with gz
%files docs
/usr/share/man/man3/*
/usr/share/doc/Lintel
%{_docdir}/Lintel-%{version}/Changelog.mtn

%files -n perl-Lintel
/usr/lib/perl5
/usr/share/perl5
/usr/share/doc/perl-Lintel

%changelog

* Fri Mar 25 2011 anderse@hpl.hp.com 0.2011.03.12-1
- Initial rpm packaging.

